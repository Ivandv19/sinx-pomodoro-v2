---
// src/components/LanguagePicker.astro
import { languages } from "../i18n/ui";
import { getRelativeLocaleUrl } from "astro:i18n";

const currentLang = Astro.currentLocale || 'es';
const currentPath = Astro.url.pathname.replace(/^\/(en|es)\//, '/').replace(/^\//, ''); 

function getLangPath(targetLang: string) {
    return getRelativeLocaleUrl(targetLang, currentPath);
}
---
<div class="relative inline-block text-left" id="lang-menu-container">
  <button 
    id="lang-menu-button"
    class="flex items-center gap-2 btn btn-ghost btn-sm px-3 hover:bg-base-200 transition-colors text-base-content/70 hover:text-base-content group"
    aria-label="Change language"
    aria-expanded="false"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-primary transition-colors">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="2" y1="12" x2="22" y2="12"></line>
      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
    </svg>
    <span class="text-xs font-bold uppercase">{currentLang}</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 group-hover:opacity-100 transition-opacity">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>

  <div 
    id="lang-menu-dropdown"
    class="absolute right-0 top-full mt-2 w-36 bg-base-100/95 backdrop-blur-md border border-base-content/10 rounded-xl shadow-xl p-1 opacity-0 invisible translate-y-2 transition-all duration-200 z-50 transform origin-top-right"
  >
    {Object.entries(languages).map(([labelLang, label]) => (
      <a
        href={getLangPath(labelLang)}
        data-lang={labelLang}
        class={`
          flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all lang-link
          ${(currentLang === labelLang) 
            ? 'bg-primary/10 text-primary' 
            : 'text-base-content/70 hover:bg-base-200 hover:text-base-content'}
        `}
      >
        <span class={`w-1.5 h-1.5 rounded-full bg-primary transition-opacity ${currentLang === labelLang ? 'opacity-100' : 'opacity-0'}`}></span>
        {label}
      </a>
    ))}
  </div>
</div>

<script is:inline>
  (function() {
    const setupPicker = () => {
      const btn = document.getElementById('lang-menu-button');
      const dropdown = document.getElementById('lang-menu-dropdown');
      const container = document.getElementById('lang-menu-container');
      
      if (!btn || !dropdown) return;
      
      let isOpen = false;

      function toggleMenu() {
        isOpen = !isOpen;
        btn.setAttribute('aria-expanded', isOpen);
        if (isOpen) {
          dropdown.classList.remove('invisible', 'opacity-0', 'translate-y-2');
        } else {
          dropdown.classList.add('invisible', 'opacity-0', 'translate-y-2');
        }
      }

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (isOpen && !container.contains(e.target)) {
          toggleMenu();
        }
      });

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen) {
          toggleMenu();
          btn.focus();
        }
      });

      // Handle language preference (for Header.astro script logic)
      const langLinks = dropdown.querySelectorAll('.lang-link');
      langLinks.forEach(link => {
        link.addEventListener('click', () => {
          const lang = link.getAttribute('data-lang');
          if (lang) {
            localStorage.setItem('language', lang);
          }
        });
      });
    };

    // Run on initial load
    setupPicker();
    // Run on View Transitions
    document.addEventListener('astro:page-load', setupPicker);
  })();
</script>
